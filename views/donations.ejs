<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Donations | Ella Rises</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Nunito+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --clr-peach-light:#F9F5EA;
      --clr-pink-soft:#FFD8D1; --clr-pink:#F9AFB1; --clr-pink-dark:#CE325B;
      --clr-sage:#9AB59D; --clr-charcoal:#3A3F3B; --clr-coral:#F4B092; --clr-blue-muted:#99B7C6;
      --clr-purple:#978EC4; --clr-white:#fff; --clr-gray-light:#f5f5f5;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Nunito Sans',sans-serif;background:var(--clr-gray-light);color:var(--clr-charcoal);min-height:100vh}

    /* Navbar */
    .navbar{background:var(--clr-white);padding:1rem 2rem;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
    .logo{font-family:'Montserrat',sans-serif;font-size:1.5rem;font-weight:700;color:var(--clr-pink-dark);text-decoration:none}
    .nav-links{list-style:none;display:flex;gap:1.5rem}
    .nav-links a{text-decoration:none;color:var(--clr-charcoal);font-weight:600}
    .nav-links a:hover{color:var(--clr-pink-dark)}

    /* Header */
    .page-header{max-width:1000px;margin:3rem auto 2rem;background:linear-gradient(135deg,var(--clr-pink-soft) 0%,var(--clr-peach-light) 100%);
    padding:2.5rem 1.5rem;border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.08);text-align:center}
    .page-header h1{font-family:'Montserrat',sans-serif;font-size:2.4rem;color:var(--clr-pink-dark);margin-bottom:.6rem}
    .page-header p{font-size:1.1rem;opacity:.9}

    /* Filters */
    .filters{max-width:1000px;margin:0 auto 1rem;display:flex;gap:.75rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .filters form{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .input, .select{padding:.65rem .9rem;border-radius:10px;border:1px solid #e0e0e0;background:#fff;min-width:240px}
    .btn{background:var(--clr-pink-dark);color:#fff;border:none;border-radius:999px;padding:.7rem 1.2rem;font-weight:700;cursor:pointer;text-decoration:none;}
    .btn:hover{background:#b72b51}

    /* Table */
    .table-wrap{max-width:1000px;margin:1.5rem auto 3rem;background:linear-gradient(135deg,var(--clr-peach-light) 0%,var(--clr-white) 100%);
    border-radius:20px;box-shadow:0 4px 20px rgba(0,0,0,.08);padding:2rem;overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    thead{background:var(--clr-pink);color:var(--clr-charcoal)}
    th,td{padding:1rem;text-align:left;border-bottom:1px solid rgba(0,0,0,.05)}
    th{font-family:'Montserrat',sans-serif;font-weight:600}
    tr:hover{background:var(--clr-pink-soft);transition:background .3s}

    /* Loading Spinner */
    .loader { text-align: center; padding: 20px; display: none; font-weight: bold; color: var(--clr-pink-dark); }
    
    /* Back to Top */
    #backToTop { display: none; position: fixed; bottom: 30px; right: 30px; z-index: 99; width: 50px; height: 50px; padding: 0; border-radius: 50%; line-height: 50px; text-align: center; font-size: 1.2rem; border: none; outline: none; background-color: var(--clr-charcoal); color: white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.3s, background-color 0.3s; }
    #backToTop:hover { transform: translateY(-5px); background-color: var(--clr-pink-dark); }

    @media (max-width:768px){
      .page-header h1{font-size:1.9rem}
      .table-wrap{padding:1rem}
      th,td{padding:.8rem}
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/" class="logo">Ella Rises</a>
    <ul class="nav-links">
      <li><a href="/dashboard">Dashboard</a></li>
      <li><a href="/participants">Participants</a></li>
      <li><a href="/events">Events</a></li>
      <li><a href="/donation_list" style="color: var(--clr-pink-dark);">Donations</a></li>
      <li><a href="/logout">Logout</a></li>
    </ul>
  </nav>

  <section class="page-header">
    <h1>Donations</h1>
    <p>Track and manage contributions to Ella Rises.</p>
  </section>

  <div class="filters">
    <form method="get" action="/donation_list">
      <input class="input" type="text" name="search" placeholder="Search donor name..." value="<%= (typeof filters !== 'undefined' && filters.search) || '' %>">
      <button class="btn" type="submit">Search</button>
    </form>
   
    <% if (user && user.role === 'admin') { %>
        <a href="/donations/add" class="btn" style="background-color: var(--clr-sage); margin-left: auto;">
          <i class="fa-solid fa-plus"></i> Add Donation
        </a>
    <% } %>
  </div>

  <div class="table-wrap">
    <table id="donationsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Donor</th>
          <th>Amount</th>
          <% if (user && user.role === 'admin') { %>
            <th style="text-align: right;">Actions</th>
          <% } %>
        </tr>
      </thead>
      <tbody id="donationsBody">
        
        <% if (typeof donations !== 'undefined' && donations.length) { %>
           <% donations.forEach(d => { %>
            <tr>
              <td>
                <strong><%= new Date(d.donation_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %></strong>
              </td>

              <td>
                 <%= d.first_name %> <%= d.last_name %>
              </td>

              <td style="font-weight: 600; color: var(--clr-charcoal);">
                $<%= Number(d.amount).toFixed(2) %>
              </td>

              <% if (user && user.role === 'admin') { %>
                <td style="text-align: right; min-width: 140px;">
                  <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <a href="/donations/edit/<%= d.donation_id %>" class="btn" style="padding: .4rem .8rem; font-size: 0.8rem; background-color: var(--clr-blue-muted);">Edit</a>
                    <form action="/donations/delete/<%= d.donation_id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete this donation?');">
                      <button type="submit" class="btn" style="padding: .4rem .8rem; font-size: 0.8rem; background-color: var(--clr-charcoal);">Delete</button>
                    </form>
                    </div>
                </td>
              <% } %>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="<%= (user && user.role === 'admin') ? 4 : 3 %>" style="text-align:center;">No donations found.</td></tr>
        <% } %>
      </tbody>
    </table>
    <div class="loader" id="loader">Loading more donations...</div>
  </div>

  <div style="text-align:center;margin-bottom:3rem;">
    <a class="btn" href="/dashboard">‚Üê Back to Dashboard</a>
  </div>

  <button onclick="topFunction()" id="backToTop" title="Go to top">
    <i class="fa-solid fa-arrow-up"></i>
  </button>

  <script>
    // --- INFINITE SCROLL & BACK TO TOP LOGIC (Matched to Events) ---
    const mybutton = document.getElementById("backToTop");
    let page = 1;
    let isLoading = false;
    let hasMore = true;

    // Search params
    const urlParams = new URLSearchParams(window.location.search);
    const currentSearch = urlParams.get('search') || '';

    window.onscroll = function() {
      if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
        mybutton.style.display = "block";
      } else {
        mybutton.style.display = "none";
      }
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
        loadMoreDonations();
      }
    };

    function topFunction() {
      document.body.scrollTop = 0;
      document.documentElement.scrollTop = 0;
    }

    async function loadMoreDonations() {
        if (isLoading || !hasMore) return;
        isLoading = true;
        document.getElementById('loader').style.display = 'block';
        page++; 

        try {
            const response = await fetch(`/donation_list?page=${page}&search=${currentSearch}`, {
                headers: { 'Accept': 'application/json' }
            });
            const data = await response.json();
           
            if (data.donations && data.donations.length > 0) {
                appendRows(data.donations, data.user);
            } else {
                hasMore = false;
                document.getElementById('loader').innerHTML = "End of list.";
            }
        } catch (error) {
            console.error('Error loading donations:', error);
        } finally {
            isLoading = false;
            if(hasMore) document.getElementById('loader').style.display = 'none';
        }
    }

    function appendRows(donations, user) {
        const tbody = document.getElementById('donationsBody');
        const isAdmin = (user && user.role === 'admin');

        donations.forEach(d => {
            const dateStr = new Date(d.donation_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            
            let actionsHtml = '';
            if (isAdmin) {
                actionsHtml = `
                    <td style="text-align: right; min-width: 140px;">
                      <div style="display: flex; gap: 8px; justify-content: flex-end;">
                        <a href="/donations/edit/${d.donation_id}" class="btn" style="padding: .4rem .8rem; font-size: 0.8rem; background-color: var(--clr-blue-muted);">Edit</a>
                        <form action="/donations/delete/${d.donation_id}" method="POST" onsubmit="return confirm('Are you sure?');">
                          <button type="submit" class="btn" style="padding: .4rem .8rem; font-size: 0.8rem; background-color: var(--clr-charcoal);">Delete</button>
                        </form>
                      </div>
                    </td>`;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${dateStr}</strong></td>
                <td>${d.first_name} ${d.last_name}</td>
                <td style="font-weight: 600; color: var(--clr-charcoal);">$${Number(d.amount).toFixed(2)}</td>
                ${actionsHtml}
            `;
            tbody.appendChild(tr);
        });
    }
  </script>
</body>
</html>